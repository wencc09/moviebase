<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MovieBase</title>

  <!-- Google Sign-In (GIS) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    body { font-family: system-ui, -apple-system, "Noto Sans TC", sans-serif; margin:0; background:#f6f7fb; }
    header { padding:16px; background:#fff; border-bottom:1px solid #eee; position: sticky; top:0; z-index:10; }
    main { max-width: 980px; margin: 0 auto; padding:16px; display:grid; gap:12px; }
    @media (min-width: 900px){ main{ grid-template-columns: 360px 1fr; align-items:start; } }

    .card { background:#fff; border:1px solid #eee; border-radius:14px; padding:14px; }
    h1 { margin:0 0 6px; font-size:18px; }
    .muted { color:#666; font-size:12px; }

    label { display:block; margin-top:10px; font-size:12px; color:#333; }
    input, select, textarea { width:100%; padding:10px; border:1px solid #ddd; border-radius:10px; }
    textarea { min-height: 80px; resize: vertical; }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:10px; }

    button { padding:10px 12px; border-radius:10px; border:1px solid #ddd; background:#fff; cursor:pointer; }
    button.primary { background:#111; color:#fff; border-color:#111; }
    button:disabled { opacity:.6; cursor:not-allowed; }

    .thumb { width:56px; height:56px; object-fit:cover; border-radius:10px; border:1px solid #eee; background:#f3f3f3; }
    .status { margin-top:10px; font-size:12px; }
    .ok { color:#0a7a2f; }
    .err { color:#b00020; }

    /* Feed post card */
    .post{background:#fff;border:1px solid #eee;border-radius:16px;overflow:hidden;}
    .post-head{display:flex;justify-content:space-between;align-items:center;padding:12px 12px 10px;}
    .post-user{display:flex;gap:10px;align-items:center;}
    .avatar{width:34px;height:34px;border-radius:999px;background:#f0f0f0;border:1px solid #eee;display:flex;align-items:center;justify-content:center;font-size:14px;}
    .post-title{font-weight:800;font-size:14px;}
    .post-sub{font-size:12px;color:#666;}
    .post-img{width:100%;display:block;background:#f3f3f3;max-height:520px;object-fit:cover;}
    .post-actions{display:flex;gap:10px;align-items:center;padding:10px 12px 0;flex-wrap:wrap;}
    .iconbtn{border:1px solid #eee;background:#fff;padding:8px 10px;border-radius:999px;font-size:12px;}
    .post-body{padding:12px;display:grid;gap:8px;}
    .badges{display:flex;flex-wrap:wrap;gap:6px;}
    .badge{border:1px solid #eee;background:#fafafa;padding:4px 8px;border-radius:999px;font-size:12px;color:#333;}
    .post-text{white-space:pre-wrap;line-height:1.5;font-size:13px;}
    .post-meta{font-size:12px;color:#666;}

    /* Tabs */
    .tabs{ margin-top:12px; display:flex; gap:8px; overflow-x:auto; padding-bottom:6px; -webkit-overflow-scrolling:touch; }
    .tab{ white-space:nowrap; border:1px solid #eee; background:#fff; padding:8px 12px; border-radius:999px; font-size:13px; }
    .tab.is-active{ background:#111; color:#fff; border-color:#111; }
    @media (max-width: 899px){ main{ grid-template-columns:1fr; } }

    .about{ margin-top:12px; border-top:1px solid #eee; padding-top:12px; }

    /* Login row */
    .loginRow{ display:flex; gap:10px; align-items:center; margin-top:10px; flex-wrap:wrap; }
    .userBox{ display:none; align-items:center; gap:8px; }
    .userPic{ width:28px; height:28px; border-radius:999px; }
  </style>
</head>

<body>
  <header>
    <h1>MovieBaseï½œé›»å½±/å½±é›†æ”¶è—</h1>
    <div class="muted">æ–°å¢ã€å¿ƒå¾—ã€è©•åˆ†ã€æ—¥æœŸã€ç…§ç‰‡ï¼ˆç…§ç‰‡å­˜ Driveï¼ŒSheet å­˜ photoUrlï¼‰</div>

    <div class="tabs" id="tabs">
      <button class="tab is-active" data-tab="feed" type="button">è²¼æ–‡ç‰†</button>
      <button class="tab" data-tab="create" type="button">æ–°å¢è²¼æ–‡</button>
      <button class="tab" data-tab="about" type="button">é—œæ–¼</button>
    </div>

    <!-- âœ… Login (Tabs å¤–é¢ï¼Œé¿å…è¢« overflow æ“‹ä½) -->
    <div class="loginRow">
      <div id="gsiBtn"></div>
      <div id="userBox" class="userBox">
        <img id="userPic" class="userPic" alt="" />
        <div class="muted" id="userName"></div>
        <button id="btnLogout" type="button">ç™»å‡º</button>
      </div>
    </div>
  </header>

  <main>
    <!-- Create -->
    <section class="card" id="panelCreate">
      <h2 style="margin:0 0 8px;font-size:16px;">æ–°å¢æ”¶è—</h2>

      <label>ç‰‡åï¼ˆå¿…å¡«ï¼‰</label>
      <input id="title" placeholder="ä¾‹å¦‚ï¼šé€²æ“Šçš„å·¨äºº" />

      <div class="row">
        <div>
          <label>é¡å‹</label>
          <select id="category">
            <option value="é›»å½±">é›»å½±</option>
            <option value="å½±é›†">å½±é›†</option>
            <option value="å‹•ç•«">å‹•ç•«</option>
            <option value="å‹•ç•«é›»å½±">å‹•ç•«é›»å½±</option>
          </select>
        </div>
        <div>
          <label>å¹³å°</label>
          <select id="platform">
            <option value="Netflix">Netflix</option>
            <option value="Disney+">Disney+</option>
            <option value="YouTube">YouTube</option>
            <option value="bilibili">bilibili</option>
            <option value="å…¶ä»–">å…¶ä»–</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>è©•åˆ†ï¼ˆ1~10ï¼‰</label>
          <input id="rating" type="number" min="1" max="10" value="8" />
        </div>
        <div>
          <label>è§€çœ‹æ—¥æœŸ</label>
          <input id="watchDate" type="date" />
        </div>
      </div>

      <label>å¿ƒå¾—</label>
      <textarea id="review" placeholder="å¯«ä¸‹ä½ çš„æ„Ÿæƒ³â€¦"></textarea>

      <label>å‚™è¨»</label>
      <input id="note" placeholder="ä¾‹å¦‚ï¼šæ¨è–¦çµ¦æœ‹å‹ / æƒ³äºŒåˆ·" />

      <label>ä¸Šå‚³ç…§ç‰‡ï¼ˆæµ·å ±/æˆªåœ–ï¼Œå¯é¸ï¼‰</label>
      <input id="photo" type="file" accept="image/*" />
      <div style="display:flex;gap:10px;align-items:center;margin-top:8px;">
        <img id="photoPreview" class="thumb" alt="" />
        <div class="muted">å»ºè­°å°æ–¼ 500KBï¼ˆä¸Šå‚³æ›´ç©©ï¼‰ã€‚</div>
      </div>

      <div style="display:flex;gap:10px;margin-top:12px;">
        <button class="primary" id="btnCreate" type="button">æ–°å¢</button>
        <button id="btnReload" type="button">é‡æ–°æ•´ç†</button>
      </div>

      <div id="status" class="status muted"></div>
    </section>

    <!-- Feed -->
    <section class="card" id="panelFeed">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <h2 style="margin:0;font-size:16px;">æˆ‘çš„æ”¶è—</h2>
        <span class="muted" id="count"></span>
        <div style="flex:1"></div>
        <input id="q" placeholder="æœå°‹ç‰‡åâ€¦" style="max-width:260px;" />
      </div>

      <div id="feed" style="margin-top:12px; display:grid; gap:12px;"></div>
      <div id="singleWrap" style="display:none; margin-top:12px;"></div>

      <div id="panelAbout" class="about" style="display:none;">
        <h3 style="margin:0 0 6px;">é—œæ–¼ MovieBase</h3>
        <div class="muted">
          é€™æ˜¯é›»å½±/å½±é›†äº¤æµè²¼æ–‡ç‰†ï¼šå¯ä¸Šå‚³ç…§ç‰‡ã€å¯«å¿ƒå¾—ã€åˆ†äº«é€£çµã€‚
          ä¹‹å¾Œå¯åŠ ï¼šå¸³è™Ÿã€ç•™è¨€ã€æŒ‰è®šã€è¿½è¹¤ã€‚
        </div>

        <details style="margin-top:10px;">
          <summary class="muted" style="cursor:pointer;">é€²éšåŠŸèƒ½ï¼ˆå¯æŠ˜ç–Šï¼‰</summary>
          <div style="margin-top:8px; display:grid; gap:8px;">
            <div class="muted">âœ… åˆ†äº«ï¼šæ¯ç¯‡è²¼æ–‡æœ‰ idï¼Œå¯ç”¨ ?id=xxx æ‰“é–‹å–®ç¯‡</div>
            <div class="muted">ğŸš§ ç•™è¨€ï¼šä¸‹ä¸€æ­¥å¯åš comments è¡¨</div>
            <div class="muted">ğŸš§ æŒ‰è®šï¼šä¸‹ä¸€æ­¥å¯åš likes è¨˜éŒ„</div>
          </div>
        </details>
      </div>
    </section>
  </main>

  <script>
    /* =========================
       âœ… 1) åŸºæœ¬è¨­å®šï¼ˆå…ˆæ”¾æœ€ä¸Šé¢ï¼‰
    ========================= */

    // æ”¹æˆä½ çš„ Apps Script /execï¼ˆä½ åŸæœ¬é‚£æ¢å³å¯ï¼‰
    const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxXHe2vAQaU0owUnjj8i8GQj_VRdfnBSEmYFdipFK6lKuvYxJvp3MpHQUGWRJRhgQ/exec";

    // ä½ çš„ Google Client IDï¼ˆä½ åŸæœ¬é‚£ä¸²å³å¯ï¼‰
    const GOOGLE_CLIENT_ID = "709445153038-ap51j4ucakhnlvdpha2cc05urj4hact3.apps.googleusercontent.com";

    const $ = (id) => document.getElementById(id);

    function setStatus(msg, type="muted") {
      const el = $("status");
      el.className = "status " + (type === "ok" ? "ok" : type === "err" ? "err" : "muted");
      el.textContent = msg || "";
    }

    function todayISO() {
      const d = new Date();
      const z = (n) => String(n).padStart(2, "0");
      return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`;
    }

    async function fileToBase64(file) {
      if (!file) return "";
      const reader = new FileReader();
      return await new Promise((resolve, reject) => {
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function apiGET(params) {
      const url = new URL(GAS_WEBAPP_URL);
      Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, v));
      const res = await fetch(url.toString());
      return await res.json();
    }

    async function apiPOST(payload) {
      const res = await fetch(GAS_WEBAPP_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload),
      });
      return await res.json();
    }

    function escapeHtml(str) {
      return (str ?? "").toString().replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    function fmtTS(ts) {
      if (!ts) return "";
      const d = new Date(ts);
      return d.toLocaleString("zh-TW", { hour12: false });
    }

    function getQueryId() {
      return new URLSearchParams(location.search).get("id");
    }

    async function copyToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        setStatus("å·²è¤‡è£½åˆ†äº«é€£çµ âœ…", "ok");
      } catch {
        prompt("è¤‡è£½é€™å€‹é€£çµåˆ†äº«ï¼š", text);
      }
    }

    /* =========================
       âœ… 2) Google ç™»å…¥ï¼ˆç©©å®šç‰ˆï¼‰
    ========================= */

    function showLoggedIn(user) {
      $("gsiBtn").style.display = "none";
      $("userBox").style.display = "flex";
      $("userName").textContent = user.name || user.email || "";
      $("userPic").src = user.picture || "";
    }

    function showLoggedOut() {
      $("gsiBtn").style.display = "block";
      $("userBox").style.display = "none";
    }

    async function restoreLogin() {
      const idToken = localStorage.getItem("id_token");
      if (!idToken) return showLoggedOut();

      try {
        const data = await apiPOST({ action: "me", idToken });
        if (!data.ok) throw new Error(data.error || "me failed");
        showLoggedIn(data.user);
      } catch (e) {
        console.error(e);
        localStorage.removeItem("id_token");
        showLoggedOut();
      }
    }

    function initGoogleLogin() {
      // é˜²å‘†ï¼šé¿å… google é‚„æ²’è¼‰å¥½å°è‡´æ•´ç«™æ›æ‰
      if (!window.google || !google.accounts?.id) {
        console.warn("Google SDK not ready");
        return;
      }

      google.accounts.id.initialize({
        client_id: GOOGLE_CLIENT_ID,
        callback: async (resp) => {
          localStorage.setItem("id_token", resp.credential);
          await restoreLogin();
        },
      });

      google.accounts.id.renderButton($("gsiBtn"), { theme: "outline", size: "large" });

      restoreLogin();
    }

    /* =========================
       âœ… 3) Feed / Single
    ========================= */

    let allRows = [];

    function renderFeed(rows) {
      const feed = $("feed");
      const singleWrap = $("singleWrap");

      feed.style.display = "grid";
      singleWrap.style.display = "none";
      singleWrap.innerHTML = "";
      feed.innerHTML = "";

      const sorted = [...rows].sort((a, b) => new Date(b.ts) - new Date(a.ts));

      sorted.forEach(r => {
        const card = document.createElement("div");
        card.className = "post";

        const avatarChar = (r.title || "?").trim().slice(0, 1);
        const imgHtml = r.photoUrl
          ? `<img class="post-img" src="${escapeHtml(r.photoUrl)}" alt="">`
          : `<div style="height:260px;background:#f3f3f3;"></div>`;

        const shareLink = `${location.origin}${location.pathname}?id=${encodeURIComponent(r.id)}`;

        card.innerHTML = `
          <div class="post-head">
            <div class="post-user">
              <div class="avatar">${escapeHtml(avatarChar)}</div>
              <div>
                <div class="post-title">${escapeHtml(r.title)}</div>
                <div class="post-sub">${escapeHtml(r.category)}ãƒ»${escapeHtml(r.platform)}ãƒ»è©•åˆ† ${escapeHtml(r.rating)}/10</div>
              </div>
            </div>
            <div class="post-sub">${escapeHtml(fmtTS(r.ts))}</div>
          </div>

          ${imgHtml}

          <div class="post-actions">
            <button class="iconbtn" data-share="${escapeHtml(r.id)}" type="button">ğŸ”— Share</button>
            <a class="iconbtn" href="?id=${encodeURIComponent(r.id)}" style="text-decoration:none;color:inherit;">ğŸ” çœ‹è²¼æ–‡</a>
          </div>

          <div class="post-body">
            <div class="badges">
              <span class="badge">æ—¥æœŸ ${escapeHtml(r.watchDate || "")}</span>
              <span class="badge">ID ${escapeHtml(r.id)}</span>
            </div>
            <div class="post-text">${escapeHtml(r.review || "")}</div>
            <div class="post-meta">${escapeHtml(r.note || "")}</div>
          </div>
        `;

        card.querySelector("[data-share]").addEventListener("click", () => copyToClipboard(shareLink));
        feed.appendChild(card);
      });

      $("count").textContent = `å…± ${sorted.length} ç­†`;
    }

    async function loadList() {
      setStatus("è¼‰å…¥ä¸­â€¦");
      try {
        const data = await apiGET({ action: "list" });
        if (!data.ok) throw new Error(data.error || "list failed");
        allRows = data.rows || [];
        applyFilter();
        setStatus("è¼‰å…¥å®Œæˆ", "ok");
      } catch (e) {
        console.error(e);
        setStatus("è¼‰å…¥å¤±æ•—ï¼šè«‹ç¢ºèª GAS_WEBAPP_URL / å¾Œç«¯æ¬Šé™", "err");
      }
    }

    async function loadSingle(id) {
      setStatus("è¼‰å…¥è²¼æ–‡ä¸­â€¦");
      try {
        const data = await apiGET({ action: "get", id });
        if (!data.ok) throw new Error(data.error || "get failed");
        const r = data.row;

        $("feed").style.display = "none";
        const singleWrap = $("singleWrap");
        singleWrap.style.display = "block";

        if (!r) {
          singleWrap.innerHTML = `<div class="muted">æ‰¾ä¸åˆ°é€™ç¯‡è²¼æ–‡ï¼ˆid=${escapeHtml(id)}ï¼‰</div>`;
          setStatus("æ‰¾ä¸åˆ°è²¼æ–‡", "err");
          return;
        }

        const shareLink = `${location.origin}${location.pathname}?id=${encodeURIComponent(r.id)}`;
        const imgHtml = r.photoUrl
          ? `<img class="post-img" src="${escapeHtml(r.photoUrl)}" alt="">`
          : `<div style="height:260px;background:#f3f3f3;"></div>`;

        singleWrap.innerHTML = `
          <div class="post">
            <div class="post-head">
              <div>
                <div class="post-title">${escapeHtml(r.title)}</div>
                <div class="post-sub">${escapeHtml(r.category)}ãƒ»${escapeHtml(r.platform)}ãƒ»è©•åˆ† ${escapeHtml(r.rating)}/10</div>
              </div>
              <div class="post-sub">${escapeHtml(fmtTS(r.ts))}</div>
            </div>

            ${imgHtml}

            <div class="post-actions">
              <button class="iconbtn" id="singleShare" type="button">ğŸ”— Share</button>
              <a class="iconbtn" href="./" style="text-decoration:none;color:inherit;">â¬… å›åˆ°è²¼æ–‡ç‰†</a>
            </div>

            <div class="post-body">
              <div class="badges">
                <span class="badge">æ—¥æœŸ ${escapeHtml(r.watchDate || "")}</span>
                <span class="badge">ID ${escapeHtml(r.id)}</span>
              </div>
              <div class="post-text">${escapeHtml(r.review || "")}</div>
              <div class="post-meta">${escapeHtml(r.note || "")}</div>
            </div>
          </div>
        `;

        $("singleShare").addEventListener("click", () => copyToClipboard(shareLink));
        setStatus("è²¼æ–‡è¼‰å…¥å®Œæˆ", "ok");
      } catch (e) {
        console.error(e);
        setStatus("è¼‰å…¥è²¼æ–‡å¤±æ•—", "err");
      }
    }

    function applyFilter() {
      const q = $("q").value.trim().toLowerCase();
      const rows = q ? allRows.filter(r => (r.title || "").toLowerCase().includes(q)) : allRows;
      renderFeed(rows);
    }

    /* =========================
       âœ… 4) Create
    ========================= */

    async function createRow() {
      const title = $("title").value.trim();
      if (!title) return setStatus("ç‰‡åå¿…å¡«", "err");

      $("btnCreate").disabled = true;
      setStatus("æ–°å¢ä¸­â€¦");

      try {
        const photoBase64 = await fileToBase64($("photo").files[0]);

        const payload = {
          action: "create",
          title,
          category: $("category").value,
          platform: $("platform").value,
          rating: Number($("rating").value || 0),
          watchDate: $("watchDate").value,
          review: $("review").value,
          note: $("note").value,
          photo: photoBase64
        };

        const data = await apiPOST(payload);
        if (!data.ok) throw new Error(data.error || "create failed");

        setStatus("æ–°å¢æˆåŠŸï¼", "ok");
        $("title").value = "";
        $("review").value = "";
        $("note").value = "";
        $("photo").value = "";
        $("photoPreview").src = "";

        await loadList();
      } catch (e) {
        console.error(e);
        setStatus("æ–°å¢å¤±æ•—ï¼šè«‹ç¢ºèªå¾Œç«¯ create", "err");
      } finally {
        $("btnCreate").disabled = false;
      }
    }

    /* =========================
       âœ… 5) Tabs
    ========================= */

    function setActiveTab(name){
      document.querySelectorAll(".tab").forEach(btn=>{
        btn.classList.toggle("is-active", btn.dataset.tab === name);
      });

      const isMobile = window.matchMedia("(max-width: 899px)").matches;

      const panelCreate = $("panelCreate");
      const panelFeed = $("panelFeed");
      const panelAbout = $("panelAbout");

      if (!isMobile){
        panelCreate.style.display = "";
        panelFeed.style.display = "";
        panelAbout.style.display = (name === "about") ? "" : "none";
        return;
      }

      if (name === "create"){
        panelCreate.style.display = "";
        panelFeed.style.display = "none";
      } else if (name === "about"){
        panelCreate.style.display = "none";
        panelFeed.style.display = "";
        panelAbout.style.display = "";
        $("feed").style.display = "none";
        $("singleWrap").style.display = "none";
      } else {
        panelCreate.style.display = "none";
        panelFeed.style.display = "";
        panelAbout.style.display = "none";

        const id = getQueryId();
        if (id) loadSingle(id);
        else loadList();
      }
    }

    /* =========================
       âœ… 6) å•Ÿå‹•ï¼ˆç­‰é é¢è¼‰å®Œï¼‰
    ========================= */

    window.addEventListener("load", () => {
      $("watchDate").value = todayISO();

      $("photo").addEventListener("change", async () => {
        const f = $("photo").files[0];
        $("photoPreview").src = f ? await fileToBase64(f) : "";
      });

      $("btnCreate").addEventListener("click", createRow);
      $("btnReload").addEventListener("click", loadList);
      $("q").addEventListener("input", applyFilter);

      $("tabs").addEventListener("click", (e) => {
        const btn = e.target.closest(".tab");
        if (!btn) return;
        setActiveTab(btn.dataset.tab);
      });

      window.addEventListener("resize", () => {
        const active = document.querySelector(".tab.is-active")?.dataset.tab || "feed";
        setActiveTab(active);
      });

      $("btnLogout").addEventListener("click", () => {
        if (window.google?.accounts?.id) google.accounts.id.disableAutoSelect();
        localStorage.removeItem("id_token");
        showLoggedOut();
      });

      // åˆå§‹åŒ–ç™»å…¥ï¼ˆè‹¥ SDK é‚„æ²’ readyï¼Œä¸æœƒè®“æ•´ç«™æ›ï¼‰
      initGoogleLogin();

      // è¼‰å…¥ï¼šå–®ç¯‡ or feed
      const id = getQueryId();
      if (id) loadSingle(id);
      else loadList();

      setActiveTab("feed");
    });
  </script>
</body>
</html>
